from flask import Flask, request, jsonify, send_from_directory, Response
import os
import json
import requests
import subprocess
from threading import Lock
from flask_cors import CORS

app = Flask(__name__, static_folder='.', static_url_path='')
CORS(app, resources={r"/*": {"origins": "*"}})

 
CHATS_DIR = "chats"
os.makedirs(CHATS_DIR, exist_ok=True)

LAST_MODEL_FILE = 'last_model.txt'
SETTINGS_FILE = 'settings.json'

 
if os.path.exists(SETTINGS_FILE):
    try:
        with open(SETTINGS_FILE, 'r', encoding='utf-8') as f:
            settings = json.load(f)
    except json.decoder.JSONDecodeError:
        settings = {"language": "en", "default_model": ""}
        with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
            json.dump(settings, f, indent=2, ensure_ascii=False)
else:
    settings = {"language": "en", "default_model": ""}
    with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
        json.dump(settings, f, indent=2, ensure_ascii=False)

current_model = settings.get("default_model", "")
model_lock = Lock()

 
OLLAMA_API = "http://localhost:11434"

 
if os.path.exists(LAST_MODEL_FILE):
    with open(LAST_MODEL_FILE, 'r', encoding='utf-8') as f:
        current_model = f.read().strip()

app.logger.info("Current model: %s", current_model)

@app.route('/')
def index():
    return send_from_directory('.', 'index3.html')

@app.route('/chats', methods=['GET'])
def list_chats():
    try:
        chats = [f.replace(".json", "") for f in os.listdir(CHATS_DIR) if f.endswith(".json")]
        return jsonify(chats)
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/chats/<chat_id>', methods=['GET', 'PUT'])
def chat_handler(chat_id):
     
     
    chat_file = os.path.join(CHATS_DIR, f"{chat_id}.json")
    if request.method == 'GET':
        try:
            if os.path.exists(chat_file):
                with open(chat_file, 'r', encoding='utf-8') as f:
                    chat_data = json.load(f)
                return jsonify(chat_data)
            else:
                return jsonify({"error": "Chat not found"}), 404
        except Exception as e:
            return jsonify({"error": str(e)}), 500
    else:
        try:
            data = request.json
            with open(chat_file, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
            return jsonify({"status": "success"})
        except Exception as e:
            return jsonify({"error": str(e)}), 500

@app.route('/delete-chat/<chat_id>', methods=['DELETE'])
def delete_chat(chat_id):
     
    chat_file = os.path.join(CHATS_DIR, f"{chat_id}.json")
    if os.path.exists(chat_file):
        try:
            os.remove(chat_file)
            return jsonify({"status": "success"})
        except Exception as e:
            return jsonify({"error": str(e)}), 500
    else:
        return jsonify({"error": "Chat not found"}), 404

@app.route('/generate', methods=['POST'])
def generate():
     
    try:
        data = request.json
        if "modelhs" in data:
            model = data["modelhs"][-1] if data["modelhs"] else current_model
        else:
            model = data.get('model', current_model)
        if "history" in data:
            messages = data["history"]
        else:
            messages = data.get('messages', [])
        payload = {
            "model": model,
            "messages": messages,
            "stream": False
        }
        resp = requests.post(f"{OLLAMA_API}/api/chat", json=payload, timeout=120)
        return jsonify(resp.json())
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/generate-stream', methods=['POST'])
def generate_stream():
     
    try:
        data = request.json
        if "modelhs" in data:
            model = data["modelhs"][-1] if data["modelhs"] else current_model
        else:
            model = data.get('model', current_model)
        if "history" in data:
            messages = data["history"]
        else:
            messages = data.get('messages', [])
        payload = {
            "model": model,
            "messages": messages,
            "stream": True
        }
        resp = requests.post(f"{OLLAMA_API}/api/chat", json=payload, stream=True, timeout=120)
        def generate():
            for line in resp.iter_lines():
                if line:
                    yield f"data: {line.decode('utf-8')}\n\n"
        return Response(generate(), mimetype='text/event-stream')
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/switch-model', methods=['POST'])
def switch_model():
     
    global current_model
    try:
        data = request.json
        model = data.get('model', '')
        with model_lock:
            current_model = model
            with open(LAST_MODEL_FILE, 'w', encoding='utf-8') as f:
                f.write(model)
        return jsonify({"status": "success", "model": model})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@app.route('/installed-models', methods=['GET'])
def get_installed_models():
     
    try:
        result = subprocess.run(["ollama", "list"], capture_output=True, text=True)
        if result.returncode != 0:
            raise Exception(result.stderr)
        output = result.stdout.strip()
        lines = output.splitlines()
        if lines and "NAME" in lines[0].upper():
            lines = lines[1:]
        models = [line.strip().split()[0] for line in lines if line.strip()]
        return jsonify(models)
    except Exception as e:
        app.logger.error("Error syncing with ollama list: %s", e)
        return jsonify([])

@app.route('/delete-model', methods=['POST'])
def delete_model():
     
    data = request.json
    model = data.get('model')
    try:
        result = subprocess.run(["ollama", "rm", model], capture_output=True, text=True)
        if result.returncode != 0:
            app.logger.error("Error deleting model: %s", result.stderr)
            return jsonify({"status": "error", "message": result.stderr}), 500
        return jsonify({"status": "success"})
    except Exception as e:
        app.logger.error("Exception deleting model: %s", e)
        return jsonify({"status": "error", "message": str(e)}), 500

@app.route('/install-model-stream', methods=['POST'])
def install_model_stream():
     
    data = request.json
    model_name = data.get("model")
    if not model_name:
        return jsonify({"error": "No model name provided"}), 400

    command = ["ollama", "run", model_name]
    app.logger.info("Installing model via command: %s", " ".join(command))

    def generate():
        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
        for line in iter(process.stdout.readline, ""):
            yield f"data: {line.strip()}\n\n"
        process.stdout.close()
        process.wait()
        yield "data: DONE\n\n"

    return Response(generate(), mimetype='text/event-stream')

@app.route('/settings', methods=['GET', 'POST'])
def settings_handler():
     
    global settings, current_model
    if request.method == 'GET':
        return jsonify(settings)
    else:
        try:
            new_settings = request.json
            settings.update(new_settings)
            with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
                json.dump(settings, f, indent=2, ensure_ascii=False)

            if "default_model" in new_settings:
                current_model = new_settings["default_model"]
                with open(LAST_MODEL_FILE, 'w', encoding='utf-8') as f:
                    f.write(current_model)

            return jsonify({"status": "success"})
        except Exception as e:
            return jsonify({"error": str(e)}), 500

# Tools API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
@app.route('/api/tools', methods=['POST'])
def execute_tool():
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏"""
    try:
        data = request.get_json()
        tool_name = data.get('tool')
        parameters = data.get('parameters', {})
        
        if tool_name == 'create_file':
            filename = parameters.get('filename')
            content = parameters.get('content', '')
            
            if not filename:
                return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞'}), 400
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(filename):
                filename = os.path.join(os.getcwd(), filename)
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            os.makedirs(os.path.dirname(filename), exist_ok=True)
            
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(content)
            
            return jsonify({'result': f'–§–∞–π–ª {filename} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ'})
        
        elif tool_name == 'read_file':
            filename = parameters.get('filename')
            
            if not filename:
                return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞'}), 400
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(filename):
                filename = os.path.join(os.getcwd(), filename)
            
            if not os.path.exists(filename):
                return jsonify({'error': f'–§–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
            
            try:
                with open(filename, 'r', encoding='utf-8') as f:
                    content = f.read()
                return jsonify({'result': f'–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ {filename}:\n{content}'})
            except UnicodeDecodeError:
                return jsonify({'error': f'–ù–µ —É–¥–∞–µ—Ç—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª {filename} (–≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª)'}), 400
        
        elif tool_name == 'create_directory':
            dirname = parameters.get('dirname')
            
            if not dirname:
                return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è –ø–∞–ø–∫–∏'}), 400
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(dirname):
                dirname = os.path.join(os.getcwd(), dirname)
            
            os.makedirs(dirname, exist_ok=True)
            
            return jsonify({'result': f'–ü–∞–ø–∫–∞ {dirname} —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ'})
        
        elif tool_name == 'list_files':
            path = parameters.get('path', os.getcwd())
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(path):
                path = os.path.join(os.getcwd(), path)
            
            if not os.path.exists(path):
                return jsonify({'error': f'–ü—É—Ç—å {path} –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
            
            if not os.path.isdir(path):
                return jsonify({'error': f'{path} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–∞–ø–∫–æ–π'}), 400
            
            files = []
            try:
                for item in os.listdir(path):
                    item_path = os.path.join(path, item)
                    if os.path.isfile(item_path):
                        size = os.path.getsize(item_path)
                        files.append(f'üìÑ {item} ({size} bytes)')
                    elif os.path.isdir(item_path):
                        files.append(f'üìÅ {item}/')
                
                files_list = '\n'.join(files) if files else '–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞'
                return jsonify({'result': f'–°–æ–¥–µ—Ä–∂–∏–º–æ–µ {path}:\n{files_list}'})
            except PermissionError:
                return jsonify({'error': f'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ {path}'}), 403
        
        elif tool_name == 'delete_file':
            filename = parameters.get('filename')
            
            if not filename:
                return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞'}), 400
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(filename):
                filename = os.path.join(os.getcwd(), filename)
            
            if not os.path.exists(filename):
                return jsonify({'error': f'–§–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
            
            try:
                if os.path.isfile(filename):
                    os.remove(filename)
                    return jsonify({'result': f'–§–∞–π–ª {filename} —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'})
                elif os.path.isdir(filename):
                    import shutil
                    shutil.rmtree(filename)
                    return jsonify({'result': f'–ü–∞–ø–∫–∞ {filename} —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ'})
                else:
                    return jsonify({'error': f'{filename} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∞–π–ª–æ–º –∏–ª–∏ –ø–∞–ø–∫–æ–π'}), 400
            except PermissionError:
                return jsonify({'error': f'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è {filename}'}), 403
        
        elif tool_name == 'edit_file':
            filename = parameters.get('filename')
            content = parameters.get('content', '')
            
            if not filename:
                return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞'}), 400
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
            if not os.path.isabs(filename):
                filename = os.path.join(os.getcwd(), filename)
            
            if not os.path.exists(filename):
                return jsonify({'error': f'–§–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
            
            if not os.path.isfile(filename):
                return jsonify({'error': f'{filename} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∞–π–ª–æ–º'}), 400
            
            try:
                # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                backup_filename = filename + '.backup'
                import shutil
                shutil.copy2(filename, backup_filename)
                
                # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                with open(filename, 'w', encoding='utf-8') as f:
                    f.write(content)
                
                return jsonify({'result': f'–§–∞–π–ª {filename} –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: {backup_filename})'})
            except Exception as e:
                return jsonify({'error': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: {str(e)}'}), 500
        
        else:
            return jsonify({'error': f'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {tool_name}'}), 400
            
    except Exception as e:
        return jsonify({'error': f'–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: {str(e)}'}), 500

if __name__ == '__main__':
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Ollama Tools...")
    print("üåê Ollama —á–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000")
    print("üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:")
    print("   - create_file: —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π)")
    print("   - read_file: —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–ª—é–±—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ)")
    print("   - edit_file: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–µ–π)")
    print("   - create_directory: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫")
    print("   - list_files: –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–æ–∫")
    print("   - delete_file: —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫")
    print("\nüí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:11434")
    print("‚ö†Ô∏è  –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ!")
    
    app.run(host='0.0.0.0', port=5000, debug=True, threaded=True)
